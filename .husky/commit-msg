#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–º–∏—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
# –§–æ—Ä–º–∞—Ç: T #{–Ω–æ–º–µ—Ä} - {—Ç–∏–ø}({–æ–±–ª–∞—Å—Ç—å}): –æ–ø–∏—Å–∞–Ω–∏–µ
# –¢–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è), –º–∞–∫—Å–∏–º—É–º 72

COMMIT_MSG=$(cat "$1")
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ (–∫–æ–º–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
if [ "$COMMIT_MSG" != "$FIRST_LINE" ]; then
  echo "‚ùå Commit message must be on a single line!"
  echo "   No line breaks allowed"
  echo ""
  echo "‚ùå Your message:"
  echo "  $COMMIT_MSG" | head -3
  echo ""
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ 50, –º–∞–∫—Å–∏–º—É–º 72 —Å–∏–º–≤–æ–ª–∞)
LENGTH=${#FIRST_LINE}
if [ $LENGTH -gt 72 ]; then
  echo "‚ùå Commit message is too long!"
  echo "   Maximum length: 72 characters"
  echo "   Recommended length: 50 characters"
  echo "   Current length: $LENGTH characters"
  echo ""
  echo "‚ùå Your message:"
  echo "  $FIRST_LINE"
  echo ""
  exit 1
elif [ $LENGTH -gt 50 ]; then
  echo "‚ö†Ô∏è  Commit message is longer than recommended (50 chars)"
  echo "   Current length: $LENGTH characters"
  echo ""
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –ø—Ä–æ–±–µ–ª—ã)
# –†–∞–∑—Ä–µ—à–∞–µ–º: a-z, A-Z, 0-9, –ø—Ä–æ–±–µ–ª—ã, –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è: - : ( ) . , ! ? # @
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
CLEANED=$(echo "$FIRST_LINE" | tr -d 'a-zA-Z0-9 \-:().,!?#@')
if [ -n "$CLEANED" ]; then
  echo "‚ùå Commit message must contain only English characters!"
  echo "   Allowed: letters (a-z, A-Z), numbers (0-9), spaces, and punctuation: - : ( ) . , ! ? # @"
  echo "   Found invalid characters: $CLEANED"
  echo ""
  echo "‚ùå Your message:"
  echo "  $FIRST_LINE"
  echo ""
  exit 1
fi

# –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–º–∏—Ç–∞
# T #{–Ω–æ–º–µ—Ä} - {—Ç–∏–ø}({–æ–±–ª–∞—Å—Ç—å}): [–æ–ø–∏—Å–∞–Ω–∏–µ]
# –û–ø–∏—Å–∞–Ω–∏–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
PATTERN="^T #[0-9]+ - (feat|fix|chore|docs|refactor|style|test)\([a-z]+\)(:|: [a-z].*)$"

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
  echo "‚ùå Invalid commit message format!"
  echo ""
  echo "üìã Required format: T #{–Ω–æ–º–µ—Ä} - {—Ç–∏–ø}({–æ–±–ª–∞—Å—Ç—å}): [–æ–ø–∏—Å–∞–Ω–∏–µ]"
  echo ""
  echo "‚úÖ Valid types: feat, fix, chore, docs, refactor, style, test"
  echo "‚úÖ Valid scopes: api, admin, client, auth, db, ui, deps, config, ci, docs, tests, mcp"
  echo ""
  echo "üìù Examples:"
  echo "  T #1 - feat(api):"
  echo "  T #5 - fix(admin):"
  echo "  T #0 - chore(deps):"
  echo "  T #1 - feat(api): add user auth"
  echo "  T #5 - fix(admin): fix validation"
  echo ""
  echo "üí° Tip: Description is optional, must be in one line."
  echo ""
  echo "‚ùå Your message:"
  echo "  $FIRST_LINE"
  echo ""
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
DESCRIPTION=$(echo "$FIRST_LINE" | sed -E 's/^T #[0-9]+ - [a-z]+\([a-z]+\): //')
if [ -n "$DESCRIPTION" ] && echo "$DESCRIPTION" | grep -qE "[A-Z]"; then
  echo "‚ùå Commit message description must be in lowercase!"
  echo "   Only lowercase English letters allowed in description"
  echo ""
  echo "‚ùå Your message:"
  echo "  $FIRST_LINE"
  echo ""
  exit 1
fi

echo "‚úÖ Commit message format is valid"
