# Speckit Workflow - Admin API

**Версия**: 1.0
**Дата**: 2025-11-27

## Обзор

Инструкция по использованию команд speckit для разработки Admin API с учетом NX монорепозитория и переиспользования логики из `libs/backend/domain`.

## Важные замечания

### NX Монорепозиторий

- **Логика в библиотеках**: Вся бизнес-логика находится в `libs/backend/domain/`
- **Переиспользование**: `api-auth` и `api-admin` используют общие библиотеки:
  - `@workix/backend/domain/auth` - для пользователей (User)
  - `@workix/backend/domain/admin` - для админов (Admin)
- **Влияние изменений**: Изменения в библиотеках влияют на все использующие их приложения
- **Согласованность**: Правила безопасности и бизнес-логика должны быть согласованы между User и Admin API

## Порядок команд Speckit

> **Важно**: Документы хранятся в `.specs/` папке каждого приложения для удобной навигации.

### 1. `/speckit.specify` - Создание спецификации

**Когда использовать**: В начале разработки новой фичи или модуля.

**Что делает**:
- Создает `spec.md` с функциональными требованиями
- Определяет user stories, edge cases, success criteria
- Устанавливает контекст и границы фичи
- **Хранится в**: `apps/{app-name}/.specs/spec.md` или `ADMIN_API_PLAN.md`

**Для Admin API**: ✅ Выполнено → `.specs/ADMIN_API_PLAN.md`

**Команда**:
```
/speckit.specify
```

---

### 2. `/speckit.clarify` - Уточнение неоднозначностей

**Когда использовать**: После создания спецификации, перед планированием.

**Что делает**:
- Выявляет неоднозначности в требованиях
- Задает уточняющие вопросы (до 5)
- Интегрирует ответы в спецификацию
- **Хранится в**: Обновляет `spec.md` в `.specs/`

**Для Admin API**: ✅ Выполнено (5 вопросов задано и ответы интегрированы)

**Команда**:
```
/speckit.clarify
```

---

### 3. `/speckit.plan` - Техническое планирование

**Когда использовать**: После уточнения спецификации, перед созданием задач.

**Что делает**:
- Создает `plan.md` с техническими деталями
- Определяет архитектуру, стек, зависимости
- Планирует фазы реализации
- Учитывает существующие библиотеки в монорепозитории
- **Хранится в**: `apps/{app-name}/.specs/plan.md` или `IMPLEMENTATION_PLAN.md`

**⚠️ КРИТИЧНО для Admin API (NX монорепозиторий)**:

1. **Существующие библиотеки**:
   - `@workix/backend/domain/auth` - используется в `api-auth` для пользователей (User)
   - `@workix/backend/domain/admin` - используется в `api-admin` для админов (Admin)
   - Это **разные библиотеки**, но могут иметь общую логику

2. **Влияние на api-auth**:
   - Если меняем общие библиотеки (например, `@workix/backend/infrastructure/*`) - влияет на `api-auth`
   - Если меняем `@workix/backend/domain/auth` - **критично**, нужно обновить тесты в `api-auth`
   - Admin API использует `@workix/backend/domain/admin` - **не влияет** на `api-auth`

3. **Что нужно определить в plan**:
   - Какие библиотеки создавать новые (`libs/backend/domain/admin-*`)
   - Какие библиотеки расширять (если нужно общую логику)
   - Что переиспользовать из существующих библиотек
   - Как обеспечить согласованность правил безопасности между User и Admin

**Команда**:
```
/speckit.plan
```

**Что проверить после выполнения**:
- [ ] Указаны используемые библиотеки из `libs/backend/domain/`
- [ ] Определено что создавать новое, что расширять
- [ ] Учтено влияние на `api-auth` (если меняем общие библиотеки)
- [ ] Планирование фаз соответствует `IMPLEMENTATION_PLAN.md`
- [ ] Указаны задачи по синхронизации правил безопасности

---

### 4. `/speckit.tasks` - Генерация задач

**Когда использовать**: После создания плана, перед началом реализации.

**Что делает**:
- Создает `tasks.md` с детальными задачами
- Организует задачи по user stories
- Определяет зависимости между задачами
- Указывает конкретные файлы для изменений
- **Хранится в**: `apps/{app-name}/.specs/tasks.md` или `TASKS.md` в корне проекта

**⚠️ ВАЖНО для Admin API**:
- Задачи должны ссылаться на библиотеки в `libs/backend/domain/`
- Указать какие библиотеки создавать/расширять
- Учесть задачи по синхронизации с `api-auth` (если нужно)

**Команда**:
```
/speckit.tasks
```

**Что проверить после выполнения**:
- [ ] Задачи ссылаются на библиотеки в `libs/`
- [ ] Указаны задачи по интеграции с существующими библиотеками
- [ ] Есть задачи по тестированию влияния на `api-auth`

---

### 5. `/speckit.checklist` - Чек-лист качества требований

**Когда использовать**: После создания задач (`/speckit.tasks`), для проверки качества спецификации.

**Что делает**:
- Создает чек-лист для проверки качества требований
- Проверяет полноту, ясность, согласованность
- Выявляет пробелы в спецификации
- **Хранится в**: `apps/{app-name}/.specs/checklists/{domain}.md`

**Для Admin API**: ✅ Выполнено → `.specs/checklists/requirements-quality.md`  
**Примечание**: Был выполнен до plan/tasks для демонстрации, но правильный порядок - после tasks

**Команда**:
```
/speckit.checklist
```

---

### 6. `/speckit.analyze` - Анализ согласованности

**Когда использовать**: После генерации задач (`/speckit.tasks`), перед началом реализации.

**Что делает**:
- Анализирует согласованность между `spec.md`, `plan.md`, `tasks.md`
- Выявляет дублирования, несоответствия, пробелы
- Проверяет соответствие constitution принципам
- **Хранится в**: `apps/{app-name}/.specs/analysis.md` или `ANALYSIS_REPORT.md`

**Для Admin API**: ✅ Выполнено → `.specs/ANALYSIS_REPORT.md`  
**Примечание**: Был выполнен до plan/tasks для демонстрации, но правильный порядок - после tasks

**Команда**:
```
/speckit.analyze
```

---

### 7. `/speckit.implement` - Реализация (опционально)

**Когда использовать**: Для автоматической генерации кода (если поддерживается).

**Что делает**:
- Генерирует код на основе спецификации и плана
- Создает структуру файлов, базовые классы
- **Осторожно**: Может потребоваться ручная доработка

**Для Admin API**: Не рекомендуется (лучше ручная реализация с учетом NX структуры)

**Статус**: Команда существует в `.cursor/commands/speckit.implement.md`

---

## Другие команды Speckit (проверка наличия)

Проверено наличие команд в `.cursor/commands/`:

- ✅ `/speckit.specify` - существует
- ✅ `/speckit.clarify` - существует
- ✅ `/speckit.plan` - существует
- ✅ `/speckit.tasks` - существует
- ✅ `/speckit.checklist` - существует
- ✅ `/speckit.analyze` - существует
- ✅ `/speckit.implement` - существует
- ❌ `/speckit.test` - **не существует**
- ❌ `/speckit.deploy` - **не существует**
- ❌ `/speckit.monitor` - **не существует**
- ❌ `/speckit.optimize` - **не существует**
- ❌ `/speckit.refactor` - **не существует**
- ❌ `/speckit.cleanup` - **не существует**
- ❌ `/speckit.docs` - **не существует**
- ❌ `/speckit.release` - **не существует**
- ❌ `/speckit.support` - **не существует**
- ❌ `/speckit.improve` - **не существует**
- ❌ `/speckit.review` - **не существует**

**Вывод**: Команды 7-20 из списка **не существуют** в проекте. Это были примеры возможных команд, но реально доступны только команды 1-7.

---

## Рекомендуемый порядок для Admin API

### Правильный порядок команд:

```
1. /speckit.specify      → Создание спецификации
2. /speckit.clarify      → Уточнение неоднозначностей
3. /speckit.plan         → Техническое планирование
4. /speckit.tasks        → Генерация задач
5. /speckit.checklist    → Чек-лист качества (после tasks)
6. /speckit.analyze      → Анализ согласованности (после tasks)
7. /speckit.implement    → Реализация (опционально)
```

### Текущий статус Admin API:

1. ✅ `/speckit.specify` → `.specs/ADMIN_API_PLAN.md` создан
2. ✅ `/speckit.clarify` → 5 вопросов задано и интегрировано
3. ⏳ `/speckit.plan` → **СЛЕДУЮЩИЙ ШАГ** (правильный порядок)
4. ⏳ `/speckit.tasks` → Ожидает plan
5. ✅ `/speckit.checklist` → `.specs/checklists/requirements-quality.md` (выполнено раньше для демо)
6. ✅ `/speckit.analyze` → `.specs/ANALYSIS_REPORT.md` (выполнено раньше для демо)

### Следующий шаг: `/speckit.plan`

**Почему сейчас**:
- Спецификация уточнена и готова
- Нужен технический план с учетом NX монорепозитория
- Нужно определить что переиспользовать из `libs/backend/domain/auth`
- Нужно спланировать влияние на `api-auth`

**Что нужно учесть при выполнении**:
- Существующие библиотеки в `libs/backend/domain/`
- Структура `api-auth` и как она использует библиотеки
- Что можно переиспользовать, что нужно расширить
- Влияние изменений на `api-auth` (если меняем общие библиотеки)

**Команда**:
```
/speckit.plan
```

---

## Влияние на api-auth (NX монорепозиторий)

### Структура библиотек:

1. **`@workix/backend/domain/auth`** (libs/backend/domain/auth):
   - Используется **только** в `api-auth` для пользователей (User)
   - Содержит: `WorkixAuthModule`, `AuthService`, `JwtGuard`, `JwtService`
   - **Не используется** в `api-admin`

2. **`@workix/backend/domain/admin`** (libs/backend/domain/admin):
   - Используется **только** в `api-admin` для админов (Admin)
   - Содержит: `WorkixAdminModule`, `AdminAuthService`, `AdminJwtGuard`, `AdminJwtService`
   - **Не используется** в `api-auth`
   - ✅ **Изменения НЕ влияют на api-auth**

3. **Общие библиотеки** (могут влиять на оба API):
   - `@workix/backend/infrastructure/prisma` - общая инфраструктура БД
   - `@workix/backend/infrastructure/i18n` - интернационализация
   - `@workix/backend/infrastructure/message-broker` - очереди сообщений
   - ⚠️ Изменения влияют на **оба** API

4. **Guards и Security**:
   - `AdminJwtGuard` (admin) vs `JwtGuard` (auth) - **разные реализации**
   - Правила безопасности должны быть **согласованы**, но реализация независима

### Рекомендации:

1. **При создании новых библиотек для Admin API**:
   - ✅ Создавать в `libs/backend/domain/admin-*` (например, `admin-services`, `admin-management`)
   - ✅ Использовать существующую `libs/backend/domain/admin` как основу
   - ❌ **НЕ трогать** `libs/backend/domain/auth` без необходимости

2. **При изменении общих библиотек**:
   - ⚠️ Проверить влияние на `api-auth`
   - Обновить тесты в `api-auth`
   - Убедиться что изменения обратно совместимы
   - Использовать feature flags если нужно разное поведение

3. **Синхронизация правил безопасности**:
   - Правила должны быть **согласованы** (например, rate limiting, password requirements)
   - Но реализация может быть **независимой** (User vs Admin)
   - Документировать различия в `ADMIN_API_SECURITY.md`

4. **Тестирование**:
   - Тесты Admin API в `apps/api-admin/**/*.spec.ts`
   - Тесты библиотек в `libs/backend/domain/admin/**/*.spec.ts`
   - После изменений общих библиотек - запустить тесты `api-auth`

---

## Быстрая справка команд

| # | Команда | Когда | Статус Admin API | Хранится в |
|---|---------|------|------------------|------------|
| 1 | `/speckit.specify` | Начало разработки | ✅ Выполнено | `.specs/ADMIN_API_PLAN.md` |
| 2 | `/speckit.clarify` | После specify | ✅ Выполнено | Обновляет spec.md |
| 3 | `/speckit.plan` | После clarify | ⏳ **Следующий шаг** | `.specs/plan.md` |
| 4 | `/speckit.tasks` | После plan | ⏳ Ожидает | `.specs/tasks.md` или `TASKS.md` |
| 5 | `/speckit.checklist` | После tasks | ✅ Выполнено* | `.specs/checklists/` |
| 6 | `/speckit.analyze` | После tasks | ✅ Выполнено* | `.specs/analysis.md` |
| 7 | `/speckit.implement` | Опционально | ❌ Не рекомендуется | - |

\* Выполнено раньше для демонстрации, но правильный порядок - после tasks

---

## Следующие действия

### ✅ Текущий статус Admin API:

1. ✅ `/speckit.specify` → `.specs/ADMIN_API_PLAN.md` создан
2. ✅ `/speckit.clarify` → 5 вопросов задано и интегрировано
3. ⏳ `/speckit.plan` → **СЛЕДУЮЩИЙ ШАГ** (правильный порядок)
4. ⏳ `/speckit.tasks` → Ожидает plan
5. ✅ `/speckit.checklist` → `.specs/checklists/requirements-quality.md` (выполнено раньше для демо)
6. ✅ `/speckit.analyze` → `.specs/ANALYSIS_REPORT.md` (выполнено раньше для демо)

### ⏳ Следующий шаг:

**Запустить `/speckit.plan`** для создания технического плана с учетом:
- NX монорепозитория
- Существующих библиотек `libs/backend/domain/`
- Влияния на `api-auth` (если меняем общие библиотеки)
- Переиспользования логики из `libs/backend/domain/admin`

**Команда**:
```
/speckit.plan
```

**После plan**:
1. Запустить `/speckit.tasks` для генерации детальных задач
2. После tasks → можно запустить `/speckit.checklist` и `/speckit.analyze` (если нужно)
3. Начать реализацию по `.specs/IMPLEMENTATION_PLAN.md` и `TASKS.md`
4. При изменении общих библиотек - проверить влияние на `api-auth`

---

## Структура папки .specs/

```
apps/api-admin/.specs/
├── README.md                          # Этот файл
├── ADMIN_API_PLAN.md                  # Спецификация (spec.md)
├── ADMIN_API_SECURITY.md              # Кейсы безопасности
├── IMPLEMENTATION_PLAN.md             # Технический план (plan.md)
├── SPECKIT_WORKFLOW.md                # Инструкция по командам
├── ANALYSIS_REPORT.md                 # Анализ согласованности
└── checklists/
    └── requirements-quality.md        # Чек-лист качества требований
```

## Связанные документы

- [ADMIN_API_PLAN.md](./ADMIN_API_PLAN.md) - Спецификация функциональности
- [IMPLEMENTATION_PLAN.md](./IMPLEMENTATION_PLAN.md) - План внедрения
- [ADMIN_API_SECURITY.md](./ADMIN_API_SECURITY.md) - Кейсы безопасности
- [ANALYSIS_REPORT.md](./ANALYSIS_REPORT.md) - Анализ согласованности
- [checklists/requirements-quality.md](./checklists/requirements-quality.md) - Чек-лист качества
- [../../TASKS.md](../../TASKS.md) - Список задач проекта
