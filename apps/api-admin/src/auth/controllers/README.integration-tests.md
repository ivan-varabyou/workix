# üß™ Integration Tests for Auth Controller

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã for checks —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ users —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –ü—Ä–µtwo—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
docker-compose -f docker-compose.test-auth.yml up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, what –ë–î –∑–∞–ø—É—â–µ–Ω–∞
docker ps | grep workix-postgres-test-auth
```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Prisma for —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î:**

```bash
cd apps/api-admin

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Äalready–Ω–∏—è for —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
export DATABASE_URL_ADMIN_TEST="postgresql://postgres:postgres@localhost:5437/workix_admin_test"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
npx prisma db push --schema=./prisma/schema.prisma --skip-generate
```

### –ó–∞–ø—É—Å–∫ via Nx

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å all —Ç–µ—Å—Ç—ã (–≤–∫–ª—é—á–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)
nx test api-admin

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
nx test api-admin --testPathPattern=integration

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
nx test api-admin --testPathPattern=integration --coverage
```

### –ó–∞–ø—É—Å–∫ via Vitest –Ω–∞–ø—Ä—è–º—É—é

```bash
cd apps/api-admin

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Äalready–Ω–∏—è
export DATABASE_URL_ADMIN_TEST="postgresql://postgres:postgres@localhost:5437/workix_admin_test"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npx vitest run src/auth/controllers/auth.controller.integration.spec.ts
```

## üìä –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Åthere–∏

### ‚úÖ –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ UUID
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫

### ‚ùå –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ù–µ–≤–µ—Ä–Ω—ã–π format email
- –°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞, what –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω –≤ –ë–î when –æ—à–∏–±–∫–µ

### üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ –ë–î
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### üìä –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö users
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Äalready–Ω–∏—è

```bash
# URL —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
DATABASE_URL_ADMIN_TEST="postgresql://postgres:postgres@localhost:5437/workix_admin_test"

# –ò–ª–∏ use —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ë–î
DATABASE_URL_ADMIN_TEST="postgresql://postgres:postgres@localhost:5432/workix_admin"
```

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–µ—Å—Ç—ã automatically –æ—á–∏—â–∞—é—Ç data before –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º:
- –£–¥–∞–ª—è—é—Ç—Å—è all users —Å email, –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è —Å `test-`

## üêõ Troubleshooting

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å status –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep workix-postgres-test-auth

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs workix-postgres-test-auth

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose -f docker-compose.test-auth.yml restart
```

### –û—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π Prisma

```bash
cd apps/api-admin

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
DATABASE_URL_ADMIN_TEST="postgresql://postgres:postgres@localhost:5437/workix_admin_test" \
  npx prisma db push --schema=./prisma/schema.prisma --skip-generate
```

### –ü–æ—Ä—Ç already –∑–∞–Ω—è—Ç

–ï—Å–ª–∏ –ø–æ—Ä—Ç 5437 –∑–∞–Ω—è—Ç, –∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ—Ä—Ç –≤ `docker-compose.test-auth.yml` –∏ –æ–±–Ω–æ–≤–∏—Ç–µ `DATABASE_URL_ADMIN_TEST`.

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É —Ç—Ä–µ–±—É—é—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–π –ë–î
- –î–∞–Ω–Ω—ã–µ automatically –æ—á–∏—â–∞—é—Ç—Å—è before –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
- –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç uses —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email for –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏who–≤
- –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç how HTTP response—ã, —Ç–∞–∫ –∏ data –≤ –ë–î
