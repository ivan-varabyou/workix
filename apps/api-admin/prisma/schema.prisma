// Prisma schema for API Admin Service
// Database: workix_admin on port 5100

generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client-admin"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_ADMIN")
}

// ============================================
// Admin Models
// ============================================

model Admin {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique @db.VarChar(255)
  passwordHash        String    @db.VarChar(255) // bcrypt hash
  name                String?   @db.VarChar(255)
  role                String    @default("admin") @db.VarChar(50) // admin, super_admin
  isActive            Boolean   @default(true)
  lastLoginAt         DateTime? @db.Timestamp
  failedLoginAttempts Int       @default(0) // Count of failed login attempts
  lockedUntil         DateTime? @db.Timestamp // Account locked until this time
  ipWhitelistEnabled  Boolean   @default(false) // Enable IP whitelist for super_admin
  twoFactorEnabled    Boolean   @default(false) // 2FA enabled
  twoFactorSecret     String?   @db.VarChar(255) // TOTP secret (encrypted in production)
  twoFactorBackupCodes String[] // Hashed backup codes
  createdAt           DateTime  @default(now()) @db.Timestamp
  updatedAt           DateTime  @updatedAt @db.Timestamp

  sessions         AdminSession[]
  auditLogs        AuditLog[]
  ipWhitelist      AdminIpWhitelist[]
  passwordResets   PasswordReset[]

  @@index([email], name: "idx_admin_email")
  @@index([role], name: "idx_admin_role")
  @@index([isActive], name: "idx_admin_active")
  @@index([lockedUntil], name: "idx_admin_locked")
  @@index([twoFactorEnabled], name: "idx_admin_2fa")
  @@map("admin")
}

model AdminSession {
  id               String   @id @default(uuid()) @db.Uuid
  adminId          String   @db.Uuid
  tokenHash        String   @unique @db.VarChar(255) // JWT token hash
  refreshTokenHash String?  @db.VarChar(255)
  ipAddress        String?  @db.VarChar(45) // IPv4 or IPv6
  userAgent        String?  @db.VarChar(500)
  expiresAt        DateTime @db.Timestamp
  createdAt        DateTime @default(now()) @db.Timestamp
  updatedAt        DateTime @updatedAt @db.Timestamp

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId], name: "idx_admin_session_admin")
  @@index([tokenHash], name: "idx_admin_session_token")
  @@index([expiresAt], name: "idx_admin_session_expires")
  @@index([adminId, expiresAt], name: "idx_admin_session_admin_expires") // Composite index for active sessions lookup
  @@map("admin_session")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  adminId      String?  @db.Uuid
  action       String   @db.VarChar(100) // create, update, delete, login, logout
  entityType   String   @db.VarChar(100) // service, application, endpoint, etc. (required)
  resourceType String?  @db.VarChar(100) // service, application, endpoint, etc. (deprecated, use entityType)
  resourceId   String?  @db.Uuid
  entityId     String?  @db.Uuid // Alias for resourceId (deprecated, use resourceId)
  details      Json? // Additional details about the action
  changes      Json? // Changes made (for compatibility)
  metadata     Json? // Additional metadata (for compatibility)
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.VarChar(500)
  createdAt    DateTime @default(now()) @db.Timestamp

  admin Admin? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId], name: "idx_audit_log_admin")
  @@index([action], name: "idx_audit_log_action")
  @@index([entityType], name: "idx_audit_log_entity")
  @@index([createdAt], name: "idx_audit_log_created")
  @@map("audit_log")
}

model AdminIpWhitelist {
  id          String   @id @default(uuid()) @db.Uuid
  adminId     String   @db.Uuid
  ipAddress   String   @db.VarChar(45) // IPv4 or IPv6
  description String?  @db.VarChar(255) // Optional description
  createdAt   DateTime @default(now()) @db.Timestamp
  updatedAt   DateTime @updatedAt @db.Timestamp

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, ipAddress], name: "uq_admin_ip_whitelist")
  @@index([adminId], name: "idx_admin_ip_whitelist_admin")
  @@index([ipAddress], name: "idx_admin_ip_whitelist_ip")
  @@map("admin_ip_whitelist")
}

model PasswordReset {
  id        String    @id @default(uuid()) @db.Uuid
  adminId   String    @db.Uuid
  userId    String?   @db.Uuid // For compatibility (not used for admin)
  token     String    @unique @db.VarChar(255) // Reset token (hex)
  expiresAt DateTime  @db.Timestamp
  usedAt    DateTime? @db.Timestamp
  ipAddress String?   @db.VarChar(45) // IPv4 or IPv6
  userAgent String?   @db.Text
  createdAt DateTime  @default(now()) @db.Timestamp

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId], name: "idx_password_reset_admin")
  @@index([token], name: "idx_password_reset_token")
  @@index([expiresAt], name: "idx_password_reset_expires")
  @@index([usedAt], name: "idx_password_reset_used")
  @@map("password_reset")
}
