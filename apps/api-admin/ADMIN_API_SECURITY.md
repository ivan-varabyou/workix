# Admin API - Кейсы безопасности

**Версия**: 1.0
**Дата**: 2025-11-27
**Статус**: Планирование

## Обзор

Документ описывает все кейсы безопасности для Admin API, включая защиту эндпоинтов, проверки прав доступа и бизнес-правила.

## Принципы безопасности

1. **Принцип наименьших привилегий** - каждый админ имеет только необходимые права
2. **Защита от самоуничтожения** - нельзя удалить/заблокировать самого себя
3. **Защита критичных операций** - super_admin операции требуют дополнительных проверок
4. **Audit logging** - все действия логируются
5. **IP Whitelist** - для super_admin обязателен IP whitelist
6. **2FA обязательна** - для super_admin обязательно включение 2FA

## Кейсы безопасности по категориям

### 1. Регистрация админа

#### Кейс 1.1: Регистрация нового админа
- **Эндпоинт**: `POST /api-admin/v1/auth/register`
- **Требования**:
  - ✅ Только `super_admin` может создавать админов
  - ✅ Требуется авторизация через `AdminJwtGuard`
  - ✅ Проверка роли через `AdminRoleGuard` с `ADMIN_ROLES_KEY: ['super_admin']`
  - ✅ Проверка что создающий админ активен (`isActive = true`)
  - ✅ Проверка что создающий админ не заблокирован (`lockedUntil = null`)
- **Защита**:
  ```typescript
  @Post('register')
  @UseGuards(AdminJwtGuard, AdminRoleGuard)
  @SetMetadata(ADMIN_ROLES_KEY, ['super_admin'])
  async register(@Body() dto: AdminRegisterDto, @Request() req: AdminRequest)
  ```
- **Бизнес-правила**:
  - Email должен быть уникальным
  - Пароль должен соответствовать требованиям (минимум 12 символов)
  - Роль по умолчанию: `admin` (нельзя создать `super_admin` через API)
  - Audit log: записывается кто создал админа

#### Кейс 1.2: Попытка регистрации без авторизации
- **Защита**: Эндпоинт защищен `AdminJwtGuard` - без токена доступ запрещен
- **Результат**: `401 Unauthorized`

#### Кейс 1.3: Попытка регистрации обычным админом
- **Защита**: `AdminRoleGuard` проверяет роль - только `super_admin`
- **Результат**: `403 Forbidden`

#### Кейс 1.4: Попытка создать super_admin через API
- **Защита**: Валидация DTO - роль `super_admin` не может быть установлена через API
- **Результат**: `400 Bad Request` - "Cannot create super_admin through API"

### 2. Управление админами

#### Кейс 2.1: Просмотр списка админов
- **Эндпоинт**: `GET /api-admin/v1/admins`
- **Требования**:
  - ✅ Требуется авторизация
  - ✅ `admin` и выше могут просматривать
- **Ограничения**:
  - Обычный `admin` видит только `admin` (не видит `super_admin`)
  - `super_admin` видит всех
  - Не показываются заблокированные админы (опционально, через фильтр)

#### Кейс 2.2: Просмотр деталей админа
- **Эндпоинт**: `GET /api-admin/v1/admins/:adminId`
- **Требования**:
  - ✅ Требуется авторизация
  - ✅ `admin` может просматривать только других `admin`
  - ✅ `super_admin` может просматривать всех
- **Защита**:
  - Проверка что запрашивающий имеет право видеть этого админа
  - Не показывается `passwordHash` в ответе

#### Кейс 2.3: Обновление админа
- **Эндпоинт**: `PUT /api-admin/v1/admins/:adminId`
- **Требования**:
  - ✅ Требуется авторизация
  - ✅ `admin` может обновлять только других `admin` (не `super_admin`)
  - ✅ `super_admin` может обновлять всех
  - ❌ Нельзя обновить самого себя (для изменения профиля есть отдельный эндпоинт)
- **Защита**:
  - Проверка что `adminId !== currentAdminId`
  - Проверка роли целевого админа
  - Audit log: записывается кто и что изменил

#### Кейс 2.4: Изменение роли админа
- **Эндпоинт**: `PUT /api-admin/v1/admins/:adminId/role`
- **Требования**:
  - ✅ Только `super_admin` может изменять роли
  - ❌ Нельзя изменить роль последнего `super_admin`
  - ❌ Нельзя изменить роль самого себя
  - ❌ Нельзя создать `super_admin` через API (только вручную в БД)
- **Защита**:
  ```typescript
  // Проверка что не последний super_admin
  const superAdminCount = await prisma.admin.count({ where: { role: 'super_admin', isActive: true } });
  if (superAdminCount <= 1 && targetAdmin.role === 'super_admin') {
    throw new ForbiddenException('Cannot change role of last super_admin');
  }
  ```

#### Кейс 2.5: Удаление админа
- **Эндпоинт**: `DELETE /api-admin/v1/admins/:adminId`
- **Требования**:
  - ✅ Только `super_admin` может удалять
  - ❌ Нельзя удалить самого себя
  - ❌ Нельзя удалить последнего `super_admin`
  - ❌ Нельзя удалить активного админа (сначала заблокировать)
- **Защита**:
  ```typescript
  if (adminId === currentAdminId) {
    throw new ForbiddenException('Cannot delete yourself');
  }
  if (targetAdmin.role === 'super_admin') {
    const superAdminCount = await prisma.admin.count({ where: { role: 'super_admin', isActive: true } });
    if (superAdminCount <= 1) {
      throw new ForbiddenException('Cannot delete last super_admin');
    }
  }
  ```

### 3. Блокировка админов

#### Кейс 3.1: Блокировка админа
- **Эндпоинт**: `POST /api-admin/v1/admins/:adminId/block`
- **Требования**:
  - ✅ `admin` может блокировать только других `admin`
  - ✅ `super_admin` может блокировать всех
  - ❌ Нельзя заблокировать самого себя
  - ❌ Нельзя заблокировать последнего `super_admin`
- **Защита**:
  - Проверка что `adminId !== currentAdminId`
  - Проверка что не последний `super_admin`
  - Отзыв всех активных сессий заблокированного админа
  - Audit log

#### Кейс 3.2: Разблокировка админа
- **Эндпоинт**: `POST /api-admin/v1/admins/:adminId/unblock`
- **Требования**:
  - ✅ Только `super_admin` может разблокировать
  - ✅ Можно разблокировать любого админа

### 4. Управление сессиями

#### Кейс 4.1: Просмотр сессий админа
- **Эндпоинт**: `GET /api-admin/v1/admins/:adminId/sessions`
- **Требования**:
  - ✅ Админ может просматривать только свои сессии
  - ✅ `super_admin` может просматривать сессии всех
- **Защита**:
  ```typescript
  if (currentAdmin.role !== 'super_admin' && adminId !== currentAdminId) {
    throw new ForbiddenException('Can only view own sessions');
  }
  ```

#### Кейс 4.2: Отзыв сессии
- **Эндпоинт**: `DELETE /api-admin/v1/admins/:adminId/sessions/:sessionId`
- **Требования**:
  - ✅ Админ может отзывать только свои сессии
  - ✅ `super_admin` может отзывать сессии всех
  - ❌ Нельзя отозвать текущую сессию (использовать `/auth/sessions/:sessionId`)
- **Защита**:
  - Проверка что сессия принадлежит админу
  - Проверка что это не текущая сессия (если админ отзывает свою)

### 5. IP Whitelist

#### Кейс 5.1: Просмотр IP Whitelist
- **Эндпоинт**: `GET /api-admin/v1/admins/:adminId/ip-whitelist`
- **Требования**:
  - ✅ Админ может просматривать только свой IP whitelist
  - ✅ `super_admin` может просматривать IP whitelist всех
- **Защита**:
  - Проверка прав доступа

#### Кейс 5.2: Добавление IP в Whitelist
- **Эндпоинт**: `POST /api-admin/v1/admins/:adminId/ip-whitelist`
- **Требования**:
  - ✅ Только `super_admin` может управлять IP whitelist
  - ✅ IP должен быть валидным (IPv4 или IPv6)
  - ✅ Нельзя добавить IP если whitelist не включен
- **Защита**:
  ```typescript
  @UseGuards(AdminJwtGuard, AdminRoleGuard)
  @SetMetadata(ADMIN_ROLES_KEY, ['super_admin'])
  ```

#### Кейс 5.3: Включение IP Whitelist
- **Эндпоинт**: `POST /api-admin/v1/admins/:adminId/ip-whitelist/toggle`
- **Требования**:
  - ✅ Только `super_admin` может включать/отключать IP whitelist
  - ✅ При включении должен быть хотя бы один IP в whitelist
- **Защита**:
  - Проверка что есть IP в whitelist перед включением

### 6. Управление серверами

#### Кейс 6.1: Просмотр статуса сервисов
- **Эндпоинт**: `GET /api-admin/v1/services`
- **Требования**:
  - ✅ Требуется авторизация
  - ✅ `admin` и выше могут просматривать
- **Ограничения**:
  - Не показываются секретные конфигурации

#### Кейс 6.2: Перезапуск сервиса
- **Эндпоинт**: `POST /api-admin/v1/services/:serviceId/restart`
- **Требования**:
  - ✅ Только `super_admin` может перезапускать сервисы
  - ❌ Нельзя перезапустить api-admin (сам себя)
- **Защита**:
  ```typescript
  if (serviceId === 'api-admin') {
    throw new ForbiddenException('Cannot restart api-admin service');
  }
  ```

#### Кейс 6.3: Просмотр конфигурации сервиса
- **Эндпоинт**: `GET /api-admin/v1/services/:serviceId/config`
- **Требования**:
  - ✅ Только `super_admin` может просматривать конфигурацию
  - ❌ Не показываются секреты (JWT_SECRET, DATABASE_URL, etc.)
- **Защита**:
  - Маскирование секретов: `JWT_SECRET=***`, `DATABASE_URL=postgresql://***`

#### Кейс 6.4: Обновление конфигурации
- **Эндпоинт**: `PUT /api-admin/v1/services/:serviceId/config`
- **Требования**:
  - ✅ Только `super_admin` может обновлять конфигурацию
  - ❌ Нельзя обновить секреты через API (только через env файлы)
  - ✅ Валидация конфигурации перед применением
- **Защита**:
  - Проверка что не пытаются изменить секреты
  - Audit log: записывается изменение конфигурации

### 7. Доступ к базам данных

#### Кейс 7.1: Просмотр статуса БД
- **Эндпоинт**: `GET /api-admin/v1/databases/:dbName/status`
- **Требования**:
  - ✅ Только `super_admin` может просматривать статус БД
  - ❌ Не показывается connection string
- **Защита**:
  - Маскирование connection string

#### Кейс 7.2: Просмотр данных БД
- **Эндпоинт**: `GET /api-admin/v1/databases/:dbName/tables`
- **Требования**:
  - ✅ Только `super_admin` может просматривать таблицы
  - ❌ Нельзя выполнять произвольные SQL запросы
- **Защита**:
  - Только read-only операции
  - Нет возможности выполнить DELETE, UPDATE, DROP

#### Кейс 7.3: Создание бэкапа
- **Эндпоинт**: `POST /api-admin/v1/databases/:dbName/backup`
- **Требования**:
  - ✅ Только `super_admin` может создавать бэкапы
  - ✅ Бэкап создается асинхронно
  - ✅ Audit log: записывается создание бэкапа

### 8. Управление платежами

#### Кейс 8.1: Просмотр подписок
- **Эндпоинт**: `GET /api-admin/v1/billing/subscriptions`
- **Требования**:
  - ✅ `admin` и выше могут просматривать
  - ❌ Не показываются данные карт, CVV
- **Защита**:
  - Маскирование данных карт: `**** **** **** 1234`

#### Кейс 8.2: Блокировка платежей пользователя
- **Эндпоинт**: `POST /api-admin/v1/billing/users/:userId/payments/block`
- **Требования**:
  - ✅ Только `super_admin` может блокировать платежи
  - ✅ Audit log: записывается блокировка
- **Защита**:
  - Проверка что пользователь существует
  - Уведомление пользователя о блокировке

#### Кейс 8.3: Изменение плана подписки
- **Эндпоинт**: `PUT /api-admin/v1/billing/subscriptions/:subscriptionId/plan`
- **Требования**:
  - ✅ Только `super_admin` может изменять планы
  - ✅ Валидация нового плана
  - ✅ Audit log: записывается изменение плана

### 9. RBAC управление

#### Кейс 9.1: Создание роли
- **Эндпоинт**: `POST /api-admin/v1/rbac/roles`
- **Требования**:
  - ✅ Только `super_admin` может создавать роли
  - ❌ Нельзя создать роль с именем `super_admin` или `admin`
- **Защита**:
  - Валидация имени роли
  - Проверка что роль не существует

#### Кейс 9.2: Изменение прав роли
- **Эндпоинт**: `PUT /api-admin/v1/rbac/roles/:roleId/permissions`
- **Требования**:
  - ✅ Только `super_admin` может изменять права
  - ❌ Нельзя изменить права роли `super_admin`
  - ❌ Нельзя удалить все права у роли `admin`
- **Защита**:
  - Проверка что роль не системная
  - Валидация прав

### 10. Audit Logs

#### Кейс 10.1: Просмотр audit logs
- **Эндпоинт**: `GET /api-admin/v1/audit/logs`
- **Требования**:
  - ✅ `admin` и выше могут просматривать
  - ✅ `support` может просматривать только свои действия
  - ❌ Не показываются секретные данные в details
- **Защита**:
  - Фильтрация по роли
  - Маскирование секретов в details

#### Кейс 10.2: Экспорт audit logs
- **Эндпоинт**: `GET /api-admin/v1/audit/export`
- **Требования**:
  - ✅ Только `super_admin` может экспортировать логи
  - ✅ Экспорт только за последние 90 дней
- **Защита**:
  - Ограничение периода экспорта
  - Rate limiting на экспорт

### 11. Безопасность

#### Кейс 11.1: Блокировка IP
- **Эндпоинт**: `POST /api-admin/v1/security/ip-blocks`
- **Требования**:
  - ✅ Только `super_admin` может блокировать IP
  - ❌ Нельзя заблокировать IP текущего админа
  - ✅ Валидация IP адреса
- **Защита**:
  - Проверка что IP валидный
  - Проверка что не блокируем свой IP

#### Кейс 11.2: Просмотр событий безопасности
- **Эндпоинт**: `GET /api-admin/v1/security/events`
- **Требования**:
  - ✅ `admin` и выше могут просматривать
  - ✅ Фильтрация по severity (critical, high, medium, low)
- **Защита**:
  - Пагинация для больших объемов данных

### 12. Изменение пароля

#### Кейс 12.1: Изменение своего пароля
- **Эндпоинт**: `POST /api-admin/v1/auth/change-password`
- **Требования**:
  - ✅ Требуется текущий пароль
  - ✅ Новый пароль должен быть сильным
  - ✅ Отзыв всех других сессий кроме текущей
- **Защита**:
  - Проверка текущего пароля
  - Валидация нового пароля

#### Кейс 12.2: Сброс пароля другого админа
- **Эндпоинт**: `POST /api-admin/v1/admins/:adminId/password-reset`
- **Требования**:
  - ✅ Только `super_admin` может сбрасывать пароли других
  - ❌ Нельзя сбросить пароль самого себя (использовать change-password)
  - ✅ Генерация временного пароля
  - ✅ Отправка пароля на email админа
- **Защита**:
  - Проверка что `adminId !== currentAdminId`
  - Audit log: записывается сброс пароля

### 13. 2FA управление

#### Кейс 13.1: Включение 2FA
- **Эндпоинт**: `POST /api-admin/v1/auth/2fa/enable`
- **Требования**:
  - ✅ Админ может включить 2FA только для себя
  - ✅ Для `super_admin` 2FA обязательна (нельзя отключить)
- **Защита**:
  ```typescript
  if (currentAdmin.role === 'super_admin' && !twoFactorEnabled) {
    throw new ForbiddenException('2FA is required for super_admin');
  }
  ```

#### Кейс 13.2: Отключение 2FA
- **Эндпоинт**: `DELETE /api-admin/v1/auth/2fa/disable`
- **Требования**:
  - ✅ Админ может отключить 2FA только для себя
  - ❌ `super_admin` не может отключить 2FA
  - ✅ Только `super_admin` может отключить 2FA другого админа
- **Защита**:
  - Проверка роли
  - Проверка что не пытается отключить 2FA у super_admin

### 14. Защита от атак

#### Кейс 14.1: Brute Force защита
- **Эндпоинт**: `POST /api-admin/v1/auth/login`
- **Защита**:
  - Rate limiting: 5 попыток в минуту
  - Блокировка после 5 неудачных попыток на 15 минут
  - Увеличение времени блокировки при повторных попытках
- **Реализация**:
  ```typescript
  @Throttle({ short: { limit: 5, ttl: 60000 } })
  @UseGuards(ThrottlerGuard)
  ```

#### Кейс 14.2: SQL Injection защита
- **Защита**:
  - Использование Prisma (параметризованные запросы)
  - Валидация всех входных данных
  - Type guards для всех параметров

#### Кейс 14.3: XSS защита
- **Защита**:
  - Валидация всех строковых входных данных
  - Санитизация HTML в ответах
  - Content Security Policy headers

#### Кейс 14.4: CSRF защита
- **Защита**:
  - Использование JWT токенов (не cookies)
  - Проверка Origin header
  - SameSite cookies (если используются)

### 15. Специальные кейсы

#### Кейс 15.1: Первый super_admin
- **Проблема**: Как создать первого super_admin если регистрация требует super_admin?
- **Решение**:
  - Первый super_admin создается вручную в БД или через seed скрипт
  - Seed скрипт выполняется только при инициализации БД
  - После создания первого super_admin, регистрация через API доступна только ему

#### Кейс 15.2: Заблокирован последний super_admin
- **Проблема**: Что если заблокирован последний super_admin?
- **Решение**:
  - Проверка перед блокировкой: нельзя заблокировать последнего super_admin
  - Если все super_admin заблокированы, разблокировка через прямой доступ к БД
  - Документация по восстановлению доступа

#### Кейс 15.3: Потеря доступа к 2FA
- **Проблема**: Что если super_admin потерял доступ к 2FA устройству?
- **Решение**:
  - Backup codes для восстановления
  - Если backup codes потеряны, другой super_admin может отключить 2FA
  - Если нет других super_admin, восстановление через прямой доступ к БД

#### Кейс 15.4: IP Whitelist блокирует доступ
- **Проблема**: Что если IP whitelist блокирует доступ super_admin?
- **Решение**:
  - Проверка IP whitelist только при включенном флаге
  - Если whitelist блокирует, можно отключить через прямой доступ к БД
  - Документация по восстановлению доступа

## Матрица защиты эндпоинтов

| Эндпоинт | Guard | Role Check | Дополнительные проверки |
|----------|-------|------------|------------------------|
| `POST /auth/register` | AdminJwtGuard | super_admin | Активен, не заблокирован |
| `POST /auth/login` | ThrottlerGuard | - | IP whitelist, 2FA |
| `GET /auth/me` | AdminJwtGuard | - | - |
| `GET /admins` | AdminJwtGuard | admin+ | Фильтрация по роли |
| `GET /admins/:id` | AdminJwtGuard | admin+ | Право видеть админа |
| `PUT /admins/:id` | AdminJwtGuard | admin+ | Не самого себя, роль целевого |
| `PUT /admins/:id/role` | AdminJwtGuard | super_admin | Не последний super_admin |
| `DELETE /admins/:id` | AdminJwtGuard | super_admin | Не самого себя, не последний super_admin |
| `POST /admins/:id/block` | AdminJwtGuard | admin+ | Не самого себя, не последний super_admin |
| `GET /services` | AdminJwtGuard | admin+ | - |
| `POST /services/:id/restart` | AdminJwtGuard | super_admin | Не api-admin |
| `GET /databases/:name/status` | AdminJwtGuard | super_admin | - |
| `POST /billing/users/:id/payments/block` | AdminJwtGuard | super_admin | - |
| `POST /rbac/roles` | AdminJwtGuard | super_admin | Валидация имени |
| `GET /audit/logs` | AdminJwtGuard | admin+ | Фильтрация по роли |

## Рекомендации по реализации

1. **Использовать Guards**:
   - `AdminJwtGuard` - для всех защищенных эндпоинтов
   - `AdminRoleGuard` - для проверки ролей
   - `ThrottlerGuard` - для rate limiting

2. **Использовать Decorators**:
   - `@SetMetadata(ADMIN_ROLES_KEY, ['super_admin'])` - для указания требуемых ролей
   - `@Throttle()` - для настройки rate limiting

3. **Валидация данных**:
   - Использовать DTO с class-validator
   - Type guards для всех параметров
   - Проверка формата UUID для ID

4. **Audit Logging**:
   - Логировать все изменения
   - Включать: кто, что, когда, откуда (IP)
   - Не логировать секреты

5. **Обработка ошибок**:
   - Не раскрывать детали ошибок в production
   - Единый формат ошибок
   - Логирование всех ошибок

## Тестирование безопасности

1. **Unit тесты**:
   - Проверка guards
   - Проверка бизнес-правил
   - Проверка валидации

2. **Integration тесты**:
   - Проверка доступа без токена
   - Проверка доступа с неправильной ролью
   - Проверка защиты от самоуничтожения
   - Проверка защиты последнего super_admin

3. **Security тесты**:
   - SQL Injection тесты
   - XSS тесты
   - CSRF тесты
   - Brute Force тесты
