# üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API Auth

**–î–∞—Ç–∞**: 2025-01-XX
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üéØ –¶–µ–ª—å

–í—ã–Ω–µ—Å—Ç–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ `api-auth` –≤ –æ–±—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ `api-admin` –∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö, —É—Å—Ç—Ä–∞–Ω–∏–≤ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞.

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### –ß–∞—Å—Ç—å 1: Account Lock Service ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ**:
- `libs/domain/auth/src/services/account-lock.service.ts` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- `libs/domain/auth/src/services/account-lock.interface.ts` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

**–û–±–Ω–æ–≤–ª–µ–Ω–æ**:
- `libs/domain/auth/src/services/auth.service.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `AccountLockService`
- `libs/domain/admin/src/services/admin-auth.service.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `AccountLockService`
- `libs/domain/auth/src/auth.module.ts` - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `AccountLockService`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (~50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)

---

### –ß–∞—Å—Ç—å 2: Generic JWT Guard ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ**:
- `libs/shared/backend/core/src/guards/generic-jwt.guard.ts` - –±–∞–∑–æ–≤—ã–π JWT guard
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã: `TokenVerificationResult`, `TokenVerifier`, `RequestDataAttacher`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ**:
- `libs/domain/admin/src/guards/admin-jwt.guard.ts` - –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `GenericJwtGuard`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

---

### –ß–∞—Å—Ç—å 3: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è ServiceAuthGuard ‚úÖ

**–û–±–Ω–æ–≤–ª–µ–Ω–æ**:
- `libs/shared/backend/core/src/guards/service-auth.guard.ts` - —Ä–∞—Å—à–∏—Ä–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –∏–∑ api-auth
- `apps/api-auth/src/app.module.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ—Ä—Å–∏—é –∏–∑ shared/backend/core

**–£–¥–∞–ª–µ–Ω–æ**:
- `apps/api-auth/src/auth/guards/service-auth.guard.ts` - –¥—É–±–ª–∏–∫–∞—Ç —É–¥–∞–ª–µ–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–¥–Ω–∞ –≤–µ—Ä—Å–∏—è `ServiceAuthGuard` –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

### –ß–∞—Å—Ç—å 4: Session Manager Service ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ**:
- `libs/shared/backend/core/src/services/session-manager.service.ts` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Å—Å–∏–π
- `libs/shared/backend/core/src/services/session-manager.interface.ts` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Å—Å–∏—è–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Å—Å–∏—è–º–∏, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è users –∏ admins

---

### –ß–∞—Å—Ç—å 5: Token Cache Service ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ**:
- `libs/shared/backend/core/src/services/token-cache.service.ts` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- `libs/shared/backend/core/src/services/token-cache.interface.ts` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- `libs/shared/backend/core/src/services/token-cache-backends/memory-cache.backend.ts` - in-memory —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `libs/shared/backend/core/src/services/token-cache-backends/redis-cache.backend.ts` - Redis —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–æ–≤

---

### –ß–∞—Å—Ç—å 6: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è Audit Log Service ‚úÖ

**–û–±–Ω–æ–≤–ª–µ–Ω–æ**:
- `libs/domain/auth/src/services/audit-log.service.ts` - —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ users –∏ admins
- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `AuditLogRepository` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- **–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤**: 12
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 8
- **–£–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 1 (–¥—É–±–ª–∏–∫–∞—Ç ServiceAuthGuard)

### –°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:
- **–í—ã–Ω–µ—Å–µ–Ω–æ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**: ~800 —Å—Ç—Ä–æ–∫
- **–£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: ~300 —Å—Ç—Ä–æ–∫
- **–ß–∏—Å—Ç—ã–π –ø—Ä–∏—Ä–æ—Å—Ç**: ~500 —Å—Ç—Ä–æ–∫ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **–°–µ—Ä–≤–∏—Å—ã**: 4 (AccountLock, SessionManager, TokenCache, AuditLog)
- **Guards**: 2 (GenericJwt, ServiceAuth)
- **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã**: 6
- **–ë—ç–∫–µ–Ω–¥—ã**: 2 (Memory, Redis)

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```
apps/api-auth/src/auth/guards/service-auth.guard.ts  ‚ùå –î—É–±–ª–∏–∫–∞—Ç
libs/domain/auth/src/services/auth.service.ts         ‚ùå –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏
libs/domain/admin/src/services/admin-auth.service.ts  ‚ùå –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏
```

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
```
libs/shared/backend/core/src/guards/service-auth.guard.ts      ‚úÖ –ï–¥–∏–Ω–∞—è –≤–µ—Ä—Å–∏—è
libs/domain/auth/src/services/account-lock.service.ts          ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π
libs/shared/backend/core/src/services/session-manager.service.ts ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π
libs/shared/backend/core/src/services/token-cache.service.ts    ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π
libs/domain/auth/src/services/audit-log.service.ts             ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏

- [x] TypeScript –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] `api-auth` —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- [x] –í—Å–µ –º–æ–¥—É–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [x] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- [x] –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ó–∞–¥–∞—á–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ:
1. **–û–±–Ω–æ–≤–∏—Ç—å SessionService** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SessionManagerService` (–∑–∞–¥–∞—á–∞ 11)
2. **–û–±–Ω–æ–≤–∏—Ç—å AdminAuthService** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SessionManagerService` –¥–ª—è —Å–µ—Å—Å–∏–π (–∑–∞–¥–∞—á–∞ 12)
3. **–û–±–Ω–æ–≤–∏—Ç—å JwtBlacklistService** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TokenCacheService` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. **–û–±–Ω–æ–≤–∏—Ç—å AdminTokenCacheService** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TokenCacheService` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. **–°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤** - –¥–ª—è SessionManager –∏ AuditLog –≤ api-admin

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ api-admin:
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `AccountLockService` –∏–∑ `@workix/domain/auth`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `GenericJwtGuard` –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö guards
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SessionManagerService` –¥–ª—è —Å–µ—Å—Å–∏–π –∞–¥–º–∏–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TokenCacheService` –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `AuditLogService` –¥–ª—è –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–æ–≤

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **JwtGuard** –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Passport (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ NestJS)
2. **GenericJwtGuard** –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö guards –±–µ–∑ Passport
3. **SessionManagerService** –∏ **TokenCacheService** —Ç—Ä–µ–±—É—é—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
4. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã - —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üéâ –ò—Ç–æ–≥

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω! –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –ö–æ–¥ —Å—Ç–∞–ª –±–æ–ª–µ–µ –º–æ–¥—É–ª—å–Ω—ã–º, –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Workix.
