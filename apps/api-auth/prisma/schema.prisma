// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_AUTH")
}

model User {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique @db.VarChar(255)
  name                String    @db.VarChar(255)
  passwordHash        String    @db.VarChar(255)
  emailVerified       Boolean   @default(false)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime? @db.Timestamp

  // User Profile fields
  firstName        String?   @db.VarChar(50)
  lastName         String?   @db.VarChar(50)
  bio              String?   @db.Text
  avatarUrl        String?   @db.Text
  phoneNumber      String?   @db.VarChar(20)
  twoFactorEnabled Boolean   @default(false)
  lastLoginAt      DateTime? @db.Timestamp

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? @db.Timestamp

  @@index([email], name: "idx_user_email")
  @@index([createdAt], name: "idx_user_created")
  @@map("users")
}

model SocialAccount {
  id                String    @id @default(uuid()) @db.Uuid
  provider          Provider
  providerAccountId String    @db.VarChar(500)
  email             String?   @db.VarChar(255)
  displayName       String?   @db.VarChar(255)
  profilePicture    String?   @db.Text
  accessToken       String?   @db.Text
  refreshToken      String?   @db.Text
  tokenExpiresAt    DateTime? @db.Timestamp
  metadata          Json?     @default("{}")
  userId            String    @db.Uuid
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("social_accounts")
}

enum Provider {
  google
  apple
  github
}

model PhoneOtp {
  id          String    @id @default(uuid()) @db.Uuid
  phoneNumber String    @db.VarChar(20)
  code        String    @db.VarChar(10)
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  expiresAt   DateTime  @db.Timestamp
  verifiedAt  DateTime? @db.Timestamp
  lockedUntil DateTime? @db.Timestamp
  metadata    Json?     @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([phoneNumber], name: "idx_phone_otp_phone")
  @@index([code], name: "idx_phone_otp_code")
  @@index([expiresAt], name: "idx_phone_otp_expires")
  @@map("phone_otps")
}

model EmailVerification {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @db.VarChar(255)
  token        String    @unique @db.VarChar(255)
  expiresAt    DateTime  @db.Timestamp
  verifiedAt   DateTime? @db.Timestamp
  resendCount  Int       @default(0)
  maxResends   Int       @default(5)
  lastResendAt DateTime? @db.Timestamp
  userId       String?   @db.Uuid
  metadata     Json?     @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email], name: "idx_email_verification_email")
  @@index([token], name: "idx_email_verification_token")
  @@index([expiresAt], name: "idx_email_verification_expires")
  @@map("email_verifications")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique @db.Text
  userId    String    @db.Uuid
  expiresAt DateTime  @db.Timestamp
  revokedAt DateTime? @db.Timestamp
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([token], name: "idx_refresh_token_token")
  @@index([userId], name: "idx_refresh_token_user")
  @@index([expiresAt], name: "idx_refresh_token_expires")
  @@map("refresh_tokens")
}

model PasswordReset {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @db.Timestamp
  usedAt    DateTime? @db.Timestamp
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([token], name: "idx_password_reset_token")
  @@index([userId], name: "idx_password_reset_user")
  @@index([expiresAt], name: "idx_password_reset_expires")
  @@index([usedAt], name: "idx_password_reset_used")
  @@map("password_resets")
}

model IpBlock {
  id           String   @id @default(uuid()) @db.Uuid
  ipAddress    String   @db.VarChar(45) // IPv4 or IPv6
  reason       String   @db.VarChar(255) // "brute_force", "sql_injection", "xss", "command_injection", "distributed_attack"
  blockedUntil DateTime @db.Timestamp
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ipAddress], name: "idx_ip_block_address")
  @@index([blockedUntil], name: "idx_ip_block_until")
  @@map("ip_blocks")
}

model AccountSecurityEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @db.Uuid
  email     String?  @db.VarChar(255)
  ipAddress String   @db.VarChar(45)
  eventType String   @db.VarChar(50) // "failed_login", "suspicious_ip", "injection_attempt", "brute_force", "distributed_attack"
  severity  String   @db.VarChar(20) // "low", "medium", "high", "critical"
  details   Json? // Additional event data
  createdAt DateTime @default(now())

  @@index([userId], name: "idx_account_security_event_user")
  @@index([email], name: "idx_account_security_event_email")
  @@index([ipAddress], name: "idx_account_security_event_ip")
  @@index([eventType], name: "idx_account_security_event_type")
  @@index([createdAt], name: "idx_account_security_event_created")
  @@map("account_security_events")
}

model AccountSecurityStatus {
  id                     String    @id @default(uuid()) @db.Uuid
  userId                 String    @unique @db.Uuid
  email                  String    @db.VarChar(255)
  isLocked               Boolean   @default(false)
  lockedUntil            DateTime? @db.Timestamp
  failedAttempts         Int       @default(0)
  lastFailedLogin        DateTime? @db.Timestamp
  suspiciousIpCount      Int       @default(0) // Count of unique IPs attempting login
  lastSuspiciousActivity DateTime? @db.Timestamp
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([email], name: "idx_account_security_status_email")
  @@index([isLocked], name: "idx_account_security_status_locked")
  @@index([lockedUntil], name: "idx_account_security_status_locked_until")
  @@map("account_security_status")
}

model SuspiciousIpActivity {
  id           String   @id @default(uuid()) @db.Uuid
  ipAddress    String   @db.VarChar(45)
  userId       String?  @db.Uuid
  email        String?  @db.VarChar(255)
  activityType String   @db.VarChar(50) // "failed_login", "injection", "xss", "command_injection", "sql_injection", "path_traversal"
  requestPath  String?  @db.VarChar(500)
  requestBody  Json? // Sanitized request body
  userAgent    String?  @db.VarChar(500)
  createdAt    DateTime @default(now())

  @@index([ipAddress], name: "idx_suspicious_ip_activity_ip")
  @@index([userId], name: "idx_suspicious_ip_activity_user")
  @@index([email], name: "idx_suspicious_ip_activity_email")
  @@index([activityType], name: "idx_suspicious_ip_activity_type")
  @@index([createdAt], name: "idx_suspicious_ip_activity_created")
  @@map("suspicious_ip_activities")
}

model UserIpLocation {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  ipAddress   String   @db.VarChar(45)
  country     String?  @db.VarChar(2) // ISO 3166-1 alpha-2 (BY, DE, etc.)
  countryName String?  @db.VarChar(100)
  region      String?  @db.VarChar(100)
  city        String?  @db.VarChar(100)
  latitude    Float?
  longitude   Float?
  isp         String?  @db.VarChar(255)
  loginCount  Int      @default(1)
  firstSeen   DateTime @default(now())
  lastSeen    DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId], name: "idx_user_ip_location_user")
  @@index([ipAddress], name: "idx_user_ip_location_ip")
  @@index([country], name: "idx_user_ip_location_country")
  @@index([userId, country], name: "idx_user_ip_location_user_country")
  @@map("user_ip_locations")
}

model SecurityVerificationCode {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @db.Uuid
  email       String    @db.VarChar(255)
  code        String    @db.VarChar(10)
  reason      String    @db.VarChar(50) // "location_change", "suspicious_activity", "new_device"
  ipAddress   String?   @db.VarChar(45)
  country     String?   @db.VarChar(2)
  countryName String?   @db.VarChar(100)
  expiresAt   DateTime  @db.Timestamp
  verifiedAt  DateTime? @db.Timestamp
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId], name: "idx_security_verification_code_user")
  @@index([email], name: "idx_security_verification_code_email")
  @@index([code], name: "idx_security_verification_code_code")
  @@index([expiresAt], name: "idx_security_verification_code_expires")
  @@map("security_verification_codes")
}

model PushSubscription {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  endpoint  String    @db.Text // Web Push endpoint URL
  p256dh    String    @db.Text // P256DH public key
  auth      String    @db.Text // Auth secret
  userAgent String?   @db.VarChar(500)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, endpoint], name: "idx_push_subscription_user_endpoint")
  @@index([userId], name: "idx_push_subscription_user")
  @@index([isActive], name: "idx_push_subscription_active")
  @@index([createdAt], name: "idx_push_subscription_created")
  @@map("push_subscriptions")
}
