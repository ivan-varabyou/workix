// Prisma schema for API Gateway
// Database: workix_gateway on port 5100

generator client {
  provider = "prisma-client-js"
}

// Seed script for initial admin
// Run: DATABASE_URL_GATEWAY=postgresql://postgres:postgres@localhost:5000/workix_gateway npx tsx prisma/seed.ts

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_GATEWAY")
}

// ============================================
// Service Configuration Models
// ============================================

model GatewayServiceConfig {
  id             String   @id @default(uuid()) @db.Uuid
  serviceName    String   @unique @db.VarChar(100)
  defaultUrl     String   @db.VarChar(500)
  currentVersion String?  @db.VarChar(50)
  fallbackUrl    String?  @db.VarChar(500)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamp
  updatedAt      DateTime @updatedAt @db.Timestamp

  versions     GatewayServiceVersion[]
  healthChecks GatewayHealthCheck[]

  @@index([serviceName], name: "idx_gateway_service_config_name")
  @@index([isActive], name: "idx_gateway_service_config_active")
  @@map("gateway_service_config")
}

model GatewayServiceVersion {
  id        String   @id @default(uuid()) @db.Uuid
  serviceId String   @db.Uuid
  version   String   @db.VarChar(50)
  url       String   @db.VarChar(500)
  port      Int? // Port number for the service
  weight    Int      @default(100) // 0-100 for load balancing
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamp
  updatedAt DateTime @updatedAt @db.Timestamp

  service GatewayServiceConfig @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, version], name: "uq_gateway_service_version")
  @@index([serviceId], name: "idx_gateway_service_version_service")
  @@index([isActive], name: "idx_gateway_service_version_active")
  @@map("gateway_service_version")
}

// ============================================
// Health Check Models
// ============================================

model GatewayHealthCheck {
  id           String   @id @default(uuid()) @db.Uuid
  serviceId    String   @db.Uuid
  status       String   @db.VarChar(20) // healthy, unhealthy, unknown
  responseTime Int? // milliseconds
  lastChecked  DateTime @default(now()) @db.Timestamp
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now()) @db.Timestamp
  updatedAt    DateTime @updatedAt @db.Timestamp

  service GatewayServiceConfig @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId], name: "idx_gateway_health_check_service")
  @@index([status], name: "idx_gateway_health_check_status")
  @@index([lastChecked], name: "idx_gateway_health_check_checked")
  @@map("gateway_health_check")
}

// ============================================
// Application & Access Control Models
// ============================================

model GatewayApplication {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  allowedServices String[] // ['auth', 'users', 'pipelines']
  allowedVersions String[] // ['v1', 'v2']
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamp
  updatedAt       DateTime @updatedAt @db.Timestamp

  whitelist GatewayEndpointWhitelist[]
  apiKeys   GatewayApiKey[]

  @@index([name], name: "idx_gateway_application_name")
  @@index([isActive], name: "idx_gateway_application_active")
  @@map("gateway_application")
}

model GatewayEndpointWhitelist {
  id              String   @id @default(uuid()) @db.Uuid
  applicationId   String   @db.Uuid
  endpointPath    String   @db.VarChar(500)
  allowedMethods  String[] // ['GET', 'POST', 'PUT', 'DELETE']
  allowedVersions String[] // ['v1', 'v2']
  rateLimit       Int? // requests per minute
  isPublic        Boolean  @default(false)
  createdAt       DateTime @default(now()) @db.Timestamp
  updatedAt       DateTime @updatedAt @db.Timestamp

  application GatewayApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, endpointPath], name: "uq_gateway_endpoint_whitelist")
  @@index([applicationId], name: "idx_gateway_endpoint_whitelist_app")
  @@index([endpointPath], name: "idx_gateway_endpoint_whitelist_path")
  @@map("gateway_endpoint_whitelist")
}

model GatewayApiKey {
  id            String    @id @default(uuid()) @db.Uuid
  applicationId String    @db.Uuid
  apiKeyHash    String    @db.VarChar(255) // bcrypt hash
  name          String?   @db.VarChar(255)
  expiresAt     DateTime? @db.Timestamp
  isActive      Boolean   @default(true)
  lastUsedAt    DateTime? @db.Timestamp
  createdAt     DateTime  @default(now()) @db.Timestamp
  updatedAt     DateTime  @updatedAt @db.Timestamp

  application GatewayApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId], name: "idx_gateway_api_key_app")
  @@index([apiKeyHash], name: "idx_gateway_api_key_hash")
  @@index([isActive], name: "idx_gateway_api_key_active")
  @@map("gateway_api_key")
}

// ============================================
// Admin Authentication Models
// ============================================

model GatewayAdmin {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique @db.VarChar(255)
  passwordHash        String    @db.VarChar(255) // bcrypt hash
  name                String?   @db.VarChar(255)
  role                String    @default("admin") @db.VarChar(50) // admin, super_admin
  isActive            Boolean   @default(true)
  lastLoginAt         DateTime? @db.Timestamp
  failedLoginAttempts Int       @default(0) // Count of failed login attempts
  lockedUntil         DateTime? @db.Timestamp // Account locked until this time
  ipWhitelistEnabled  Boolean   @default(false) // Enable IP whitelist for super_admin
  twoFactorEnabled    Boolean   @default(false) // 2FA enabled
  twoFactorSecret     String?   @db.VarChar(255) // TOTP secret (encrypted in production)
  twoFactorBackupCodes String[] // Hashed backup codes
  createdAt           DateTime  @default(now()) @db.Timestamp
  updatedAt           DateTime  @updatedAt @db.Timestamp

  sessions         GatewayAdminSession[]
  auditLogs        GatewayAuditLog[]
  ipWhitelist      GatewayAdminIpWhitelist[]
  passwordResets   GatewayPasswordReset[]

  @@index([email], name: "idx_gateway_admin_email")
  @@index([role], name: "idx_gateway_admin_role")
  @@index([isActive], name: "idx_gateway_admin_active")
  @@index([lockedUntil], name: "idx_gateway_admin_locked")
  @@index([twoFactorEnabled], name: "idx_gateway_admin_2fa")
  @@map("gateway_admin")
}

model GatewayAdminSession {
  id               String   @id @default(uuid()) @db.Uuid
  adminId          String   @db.Uuid
  tokenHash        String   @unique @db.VarChar(255) // JWT token hash
  refreshTokenHash String?  @db.VarChar(255)
  ipAddress        String?  @db.VarChar(45) // IPv4 or IPv6
  userAgent        String?  @db.VarChar(500)
  expiresAt        DateTime @db.Timestamp
  createdAt        DateTime @default(now()) @db.Timestamp
  updatedAt        DateTime @updatedAt @db.Timestamp

  admin GatewayAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId], name: "idx_gateway_admin_session_admin")
  @@index([tokenHash], name: "idx_gateway_admin_session_token")
  @@index([expiresAt], name: "idx_gateway_admin_session_expires")
  @@index([adminId, expiresAt], name: "idx_gateway_admin_session_admin_expires") // Composite index for active sessions lookup
  @@map("gateway_admin_session")
}

model GatewayAuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  adminId      String?  @db.Uuid
  action       String   @db.VarChar(100) // create, update, delete, login, logout
  resourceType String   @db.VarChar(100) // service, application, endpoint, etc.
  resourceId   String?  @db.Uuid
  details      Json? // Additional details about the action
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.VarChar(500)
  createdAt    DateTime @default(now()) @db.Timestamp

  admin GatewayAdmin? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId], name: "idx_gateway_audit_log_admin")
  @@index([action], name: "idx_gateway_audit_log_action")
  @@index([resourceType], name: "idx_gateway_audit_log_resource")
  @@index([createdAt], name: "idx_gateway_audit_log_created")
  @@map("gateway_audit_log")
}

// ============================================
// Admin IP Whitelist Model
// ============================================

model GatewayAdminIpWhitelist {
  id          String   @id @default(uuid()) @db.Uuid
  adminId     String   @db.Uuid
  ipAddress   String   @db.VarChar(45) // IPv4 or IPv6
  description String?  @db.VarChar(255) // Optional description
  createdAt   DateTime @default(now()) @db.Timestamp
  updatedAt   DateTime @updatedAt @db.Timestamp

  admin GatewayAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, ipAddress], name: "uq_gateway_admin_ip_whitelist")
  @@index([adminId], name: "idx_gateway_admin_ip_whitelist_admin")
  @@index([ipAddress], name: "idx_gateway_admin_ip_whitelist_ip")
  @@map("gateway_admin_ip_whitelist")
}

// ============================================
// Admin Password Reset Model
// ============================================

model GatewayPasswordReset {
  id        String    @id @default(uuid()) @db.Uuid
  adminId   String    @db.Uuid
  token     String    @unique @db.VarChar(255) // Reset token (hex)
  expiresAt DateTime  @db.Timestamp
  usedAt    DateTime? @db.Timestamp
  ipAddress String?   @db.VarChar(45) // IPv4 or IPv6
  userAgent String?   @db.Text
  createdAt DateTime  @default(now()) @db.Timestamp

  admin GatewayAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId], name: "idx_gateway_password_reset_admin")
  @@index([token], name: "idx_gateway_password_reset_token")
  @@index([expiresAt], name: "idx_gateway_password_reset_expires")
  @@index([usedAt], name: "idx_gateway_password_reset_used")
  @@map("gateway_password_reset")
}
